node {
    def mvnHome
    stage('Prepare') {
        git 'git@github.com:yiren1105/devops.git'
        mvnHome = tool 'maven'
    }
    stage('Build') {
        if(isUnix()) {
            sh "'${mvnHome}/bin/mvn' -Dmaven.test.failure.ignore clean package"
        } else {
            bat(/"${mvnHome}\bin\mvn" -Dmaven.test.failure.ignore clean package/)
        }
    }
    stage('Unit Test') {
        junit '**/target/surefile-reports/TEST-*.xml'
        archive 'target/*.jar'
    }
    stage('Sonar') {
        if(isUnix()) {
            sh "'${mvnHome}/bin/mvn' sonar:sonar"
        } else {
            bat(/"${mvnHome}\bin\mvn" sonar:sonar/)
        }
    }
    stage('Deploy') {
        sh 'curl -u jenkins:jenkins -T target/**.war "http://localhost:8080/manager/text/deploy?path=/devops&update=true"'  
    }
    stage('Smoke Test') {
        sh "curl --retry-delay 10 --retry 5 http://localhost:8080/devops"
    }
}